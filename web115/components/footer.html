<!-- components/footer.html -->
<footer>
  <section>
    <p>
      <a href="https://itamar96.github.io/index.html" target="_blank" rel="noopener noreferrer">GitHub.io</a> ✶
      <a href="https://github.com/Itamar96" target="_blank" rel="noopener noreferrer">GitHub</a> ✶
      <a href="https://itamar96.github.io" target="_blank" rel="noopener noreferrer">Portfolio</a> ✶
      <a href="https://www.codecademy.com/profiles/Itamar96" target="_blank" rel="noopener noreferrer">Codecademy</a> ✶
      <a href="https://www.freecodecamp.org/itamar96" target="_blank" rel="noopener noreferrer">freeCodeCamp</a> ✶
      <a href="https://jsfiddle.net/u/Itamar96/fiddles/" target="_blank" rel="noopener noreferrer">JSFiddle</a> ✶
      <a href="https://www.linkedin.com/in/itamar-castillo-6137b8380/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
      <span id="validate-link-placeholder"></span>
    </p>
    <p><em>Page built by Iridescent Cinderwyrm Design</em></p>
  </section>
</footer>
<!-- Centralized scripts: include loader, head injection, theme toggle, and active link highlight -->
<script>
  (function () {
    // Inject shared head fragment into document.head safely.
    // Replaces {{pagetitle}} with a per-page meta[name="page-title"] or the existing document.title.
    function injectHeadFragment() {
      try {
        fetch('components/head.html', { cache: 'no-cache' }).then(res => res.text()).then(html => {
          const pageTitleMeta = document.querySelector('meta[name="page-title"]');
          const pageTitle = pageTitleMeta ? pageTitleMeta.content : (document.title || 'Iridescent Cinderwyrm');
          html = html.replace(/\{\{pagetitle\}\}/g, pageTitle);

          const container = document.createElement('div');
          container.innerHTML = html;

          // Helper to check if a similar node already exists in head
          function existsLike(node) {
            if (node.nodeType !== 1) return false;
            const tag = node.tagName.toLowerCase();
            if (tag === 'title') return !!document.head.querySelector('title');
            if (tag === 'meta') {
              const name = node.getAttribute('name');
              if (name) return !!document.head.querySelector('meta[name="' + name + '"]');
              const prop = node.getAttribute('property');
              if (prop) return !!document.head.querySelector('meta[property="' + prop + '"]');
              return false;
            }
            if (tag === 'link') {
              const href = node.getAttribute('href');
              const rel = node.getAttribute('rel');
              if (href && rel) return !!document.head.querySelector('link[rel="' + rel + '"][href="' + href + '"]');
            }
            if (tag === 'script') {
              const src = node.getAttribute('src');
              if (src) return !!document.head.querySelector('script[src="' + src + '"]');
            }
            return false;
          }

          Array.from(container.childNodes).forEach(node => {
            if (existsLike(node)) {
              // If it's a title, prefer replacing the existing one text; otherwise skip duplicate
              if (node.nodeType === 1 && node.tagName.toLowerCase() === 'title') {
                const existing = document.head.querySelector('title');
                if (existing) existing.textContent = node.textContent;
              }
              return;
            }
            // Move node into head
            document.head.appendChild(node);
          });
        }).catch(() => {/* non-fatal */});
      } catch (e) { /* ignore */ }
    }

    // ensure includeHTML exists: if not, load it once and then call includeHTML
    function ensureIncludes(cb) {
      if (typeof includeHTML === 'function') return cb();
      if (document.querySelector('script[data-htmlinclude]')) return setTimeout(() => ensureIncludes(cb), 60);
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/gh/Paul-Browne/HTMLInclude/include.min.js';
      s.setAttribute('data-htmlinclude', '1');
      s.onload = () => { if (typeof includeHTML === 'function') includeHTML(); cb(); };
      s.onerror = cb;
      document.head.appendChild(s);
    }

    // Inject head fragment now (safe no-op if components/head.html is already merged).
    injectHeadFragment();

    function persistTheme(isDark) {
      try { localStorage.setItem('ic-dark', isDark ? '1' : '0'); } catch (e) {}
    }

    function readPersistedTheme() {
      try { return localStorage.getItem('ic-dark') === '1'; } catch (e) { return false; }
    }

    function initUI() {
      const toggle = document.getElementById('theme-toggle');
      // apply persisted theme first
      const persisted = readPersistedTheme();
      if (persisted) document.body.classList.add('dark-theme');

      if (toggle) {
        const isDark = document.body.classList.contains('dark-theme');
        toggle.setAttribute('aria-pressed', isDark ? 'true' : 'false');
        if (!toggle.dataset.hasHandler) {
          toggle.addEventListener('click', () => {
            const nowDark = document.body.classList.toggle('dark-theme');
            toggle.setAttribute('aria-pressed', nowDark ? 'true' : 'false');
            persistTheme(nowDark);
          });
          toggle.dataset.hasHandler = 'true';
        }
      }

      // highlight nav link robustly
      const current = window.location.pathname.split('/').pop() || 'index.html';
      document.querySelectorAll('nav a').forEach(a => {
        try {
          if (a.getAttribute('href') === current) a.setAttribute('aria-current', 'page');
        } catch (e) {}
      });

      // Insert a dynamic "Validate this page" link that targets the W3C validator
      try {
        const placeholder = document.getElementById('validate-link-placeholder');
        if (placeholder && !placeholder.dataset.inserted) {
          const validator = document.createElement('a');
          const currentHref = window.location.href;
          const encoded = encodeURIComponent(currentHref);
          validator.href = 'https://validator.w3.org/nu/?doc=' + encoded;
          validator.target = '_blank';
          validator.rel = 'noopener noreferrer';
          validator.className = 'footer-link';
          validator.textContent = 'Validate this page';
          // add a separator
          const sep = document.createElement('span'); sep.textContent = ' ✶ '; sep.setAttribute('aria-hidden', 'true');
          placeholder.appendChild(sep);
          placeholder.appendChild(validator);
          placeholder.dataset.inserted = '1';
        }
      } catch (e) { /* non-fatal */ }
    }

    // Run includes then init UI. Also run init on DOMContentLoaded as fallback.
    ensureIncludes(() => setTimeout(initUI, 40));
    document.addEventListener('DOMContentLoaded', initUI);
  })();
</script>
